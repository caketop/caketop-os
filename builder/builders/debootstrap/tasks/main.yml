---
- block:

  - name: Force rebuild of debootstrap
    file:
      state: absent
      path: /mnt/cache/debootstrap.done

  when: clean_debootstrap

- block:

  - name: Clean debootstrap directory
    file:
      state: absent
      path: /mnt/cache/debootstrap

  - name: Run debootstrap
    command:
      argv:
        - debootstrap
        - --variant={{ debootstrap_variant }}
        - --include={{ debootstrap_include }}
        - "{{ debootstrap_suite }}"
        - /mnt/cache/debootstrap
        - "{{ debootstrap_mirror }}"
      creates: /mnt/cache/debootstrap
    environment: "{{ proxy_env }}"

  - name: Mark debootstrap as done
    file:
      state: touch
      path: /mnt/cache/debootstrap.done

  when: "'/mnt/cache/debootstrap.done' is not exists"
